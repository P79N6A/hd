<div class="form-group">
    <label class="control-label col-md-2">
        地区<br>
        <?php if(isset($addregion)&&$addregion) {?>
        <button type="button" class="btn btn-xs blue add-address"><i class="fa fa-plus"></i> 增加地区</button>
        <?php }?>
    </label>
    <div class="col-md-10" id="media-address">
        <div>
            <select name="country_id0" class="form-control input-small region-control1 region" ></select>
            <select name="province_id0" class="form-control input-small region-control2 region region-left"></select>
            <select name="city_id0" class="form-control input-small region-control3 region region-left"></select>
            <select name="county_id0" class="form-control input-small region-control4 region region-left"></select>
            <select name="town_id0" class="form-control input-small region-control5 region region-left"></select>
            <select name="village_id0" class="form-control input-small region-control6 region region-left"></select>
            <input name=description type="text" placeholder="备注" value="" maxlength="200" class="form-control input-small maxlength-handler validate-box region region-left"/>
        </div>
    </div>
</div>
<div class="form-group">
    <label class="control-label col-md-2">
        部门<br />
    </label>
    <div class="col-md-10" id="media-address">
        <div>
            <select name="government_id" class="form-control input-small government-control1 region" ></select>
        </div>
    </div>
</div>

<script type="text/javascript">
    $($.ajax({
        type: "POST",
        url: "/regions/default",
        data: "id = 1",
        success: function(msg) {
            var str = JSON.parse(msg);
          //  $('.region-control1').append('<option value="0">请选择</option>');
            
            for(var i = 0; i < str.length; i++) {
                $('.region-control1').append('<option value="'+str[i]['id']+'">'+str[i]['name']+'</option>');
            }
            <?php if(isset($region) && $region && $region->country_id) {?>
         	 	$('.region-control1').val(<?= $region->country_id?>);
            <?php }?>

            <?php if(isset($region) && $region && isset($region->province_id) && $region->province_id) {
                $province = Regions::fetchById($region->province_id);  ?>
            	$('.region-control2').append('<option value="<?=$province->id?>"><?=$province->name?></option>');
				
            <?php } ?>
            getRegion($('.region-control2'),$('.region-control1').val(),$('.region-control2').val(),2);
            <?php if(isset($region) && $region && isset($region->city_id) && $region->city_id) {
                $city = Regions::fetchById($region->city_id); ?>
                $('.region-control3').append('<option value="<?=$city->id?>"><?=$city->name?></option>');
            <?php } ?>
            getRegion($('.region-control3'),$('.region-control2').val(),$('.region-control3').val(),3);	
            <?php if(isset($region) && $region && isset($region->county_id) && $region->county_id) {
                $county = Regions::fetchById($region->county_id); ?>
            	$('.region-control4').append('<option value="<?=$county->id?>"><?=$county->name?></option>');
				
			<?php }?>	
			getRegion($('.region-control4'),$('.region-control3').val(),$('.region-control4').val(),4);
			<?php if(isset($region) && $region && isset($region->town_id) && $region->town_id) {
                $town = Regions::fetchById($region->town_id); ?>
            	$('.region-control5').append('<option value="<?=$town->id?>"><?=$town->name?></option>');
			<?php } ?>
				getRegion($('.region-control5'),$('.region-control4').val(),$('.region-control5').val(),5);
		   <?php if(isset($region) && $region && isset($region->village_id) && $region->village_id) {
	            $village = Regions::fetchById($region->village_id)?>
	            $('.region-control6').append('<option value="<?=$village->id?>"><?=$village->name?></option>');
           <?php }?>
            	
            checkEmpty();

            $('.government-control1').append('<option value="0">请选择</option>');
            <?php if(isset($government) && $government && isset($government->id) && $government->id) {?>
           		findGovernment( $('.government-control1'),<?= $government->id?>);
			<?php }else{?>
				findGovernment( $('.government-control1'),0);
			<?php }?>
        }
    }));


    function getRegion($val,id,$regionId,num) {
          if($val != 0 && id != null) {
            $.ajax({
                type: "POST",
                url: "/regions/default",
                data: "id=" + id,
                success: function(msg) {
                    var str = JSON.parse(msg);
	                    if(str != '') {
		                    if( $regionId != null){
	                        	for(var i = 0; i < str.length; i++) {
		                        	if($regionId != str[i]['id']){
                    					$val.append('<option value="' + str[i]['id'] + '">' + str[i]['name'] + '</option>');
		                        	}
	                        	} 
		                    }else{
		                    		$val.append('<option value="0">请选择</option>');
	                        		for(var i = 0; i < str.length; i++) {
			                   			$val.append('<option value="' + str[i]['id'] + '">' + str[i]['name'] + '</option>');
	                        		}
	                        		$('.region-control' + num).show();
		                        }
	                    }
	                } 
            });
        }
    }

    function findGovernment($val,$id) {
        var id = $id;
         $.ajax({
             type: "POST",
             url: "/government_department/find",
             data: {id:0, channel_id:<?php echo Auth::user()->channel_id; ?>},
             success: function(msg) {
                 var str = JSON.parse(msg);
                 if(str != '') {
                 for(var i = 0; i < str.length; i++) {
                   	$val.append('<option value="' + str[i]['id'] + '">' + str[i]['name'] + '</option>');
                 }
                 $val.val(id);
             }
         } 
    });
 }

  
    function findRegion($this) {
        if($($this).val() != 0) {
            $.ajax({
                type: "POST",
                url: "/regions/default",
                data: "id=" + $($this).val(),
                success: function(msg) {
                    var str = JSON.parse(msg);
                    if(str != '') {
                        $($this).next().append('<option value="0">请选择</option>');
                        for(var i = 0; i < str.length; i++) {
                            $($this).next().append('<option value="' + str[i]['id'] + '">' + str[i]['name'] + '</option>');
                        }
                    }
                    checkEmpty();
                }
            });
        }
        else {
            checkEmpty();
        }
    }

    function checkEmpty() {
    	$('.region-control1').hide();
        for(var i = 2; i <= 6; i++) {
            $('.region-control' + i).show();
            if(!$('.region-control'+i).val()) {
                $('.region-control' + i).hide();
            }
        }
    }

    $(".region").change(function() {
        $(this).nextUntil("div").empty();
        $(this).nextUntil("div").val("");
        findRegion(this);
    });
</script>