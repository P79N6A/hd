<?php
$this->partial("partials/breadcrumb", [
    'urls' => [$name=>Url::get('features/index'),'媒资列表' => Url::get('features/mediaindex?id='.$feature_id.'&name='.$name)],
    'add'=> Url::get(""),
    'html' => '',
]);
?>
<div class="table-info table-responsive sortable ui-sortable" id="sorttable">
    <table class="table table-striped table-hover table-bordered">
        <thead>
            <tr>
                <th class="table-checkbox">选择</th>
                <th>标题</th>
                <th>媒资类型</th>
                <th>修改时间</th>
                <th>编辑</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="sortbody">
        <?php foreach($parcel->models as $model):
        if(!($model->data->id > 0))  continue; 
         ?>
             <tr class="sortr-user" cat_id="<?=$model->featuredData->id?>" rel="<?=$model->featuredData->sort?>">
                <td class="checkbox-middle sortr-handle">
                    <input type="checkbox" class="checkboxes" value="<?= $model->data->id?>"/>
                </td>
                <td>
                    <img class="small-img" src="<?= $model->data->thumb? (cdn_url('image',$model->data->thumb)): '/assets/admin/layout/cztv_img/defaultlogo.png'; ?>"/>
                    <span class="name-center">
                        <?= $model->data->title;?>
                    </span>
                </td>
                <?php
                switch( $model->data->type) {
                    case 'news':
                        $edit_pre = 'media_posts';
                        $media_type = '新闻';
                        break;
                    case 'album':
                        $edit_pre = 'media_albums';
                        $media_type = '相册';
                        break;
                    case 'video':
                        $edit_pre = 'media_video';
                        $media_type = '视频';
                        break;
                    case 'signals':
                       	$edit_pre = 'media_signals';
                       	$media_type = '直播';
                       	break;
                    case 'multimedia':
                       	$edit_pre = 'publish';
                       	$media_type = '聚合媒资';
                       	break;
                    default:
                        throw new \Phalcon\Exception('Invalid media type');
                }
                $edit_url = Url::get($edit_pre.'/edit', ['id' => $model->data->source_id]);
                ?>
                <td><?= $media_type?></td>
                <td><?php echo date('Y-m-d',$model->data->updated_at)?></td>
                <td><?= $model->data->author_name;?></td>
                <td><span class="<?= $model->data->status == 1 ? '': ($model->data->status == 9 ? 'font-red' : 'font-red-haze') ?>"><?= $model->data->status == 1 ? '已经发布': ($model->data->status == 9 ? '待审核' : '未发布') ?></span></td>
                <td>
                    <div class="btn-group btn-group-xs btn-group-solid">
                        <!-- <button type="button" class="btn purple tooltips" value="" data-container="body" data-placement="top" data-trigger="hover" data-html="true" data-original-title="预览"><i class="fa fa-eye"></i></button> -->
                        <?php if($edit_pre!='media_video') :?>
                        <button type="button" class="btn green edit-content tooltips" data-url="<?= $edit_url ;?>" data-container="body" data-placement="top" data-trigger="hover" data-html="true" data-original-title="编辑"><i class="fa fa-edit"></i></button>
                        <?php endif?>
                        <?php if($checkAuth('features/binding')){ ?>
                        <button type="button" class="btn blue edit-content tooltips"
                                data-url="<?= Url::get('features/binding', ['id' => $model->data->id]); ?>"
                                data-container="body" data-placement="top" data-trigger="hover" data-html="true"
                                data-original-title="绑定推荐位"><i class="fa fa-database"></i></button>
                        <?php }?>
                        <button type="button" class="btn red tooltips" onclick="show_confirm(this)" data-url="/features/mediadelete?id=<?= $model->featuredData->id?>" data-toggle="modal" data-container="body" data-placement="top" data-trigger="hover" data-html="true" data-original-title="解除绑定"><i class="fa fa-trash-o"></i></button>
                    </div>
                </td>
            </tr>
        <?php endforeach ?>
        <?php if(count($parcel->models) == 0) { ?>
            <tr class="sortable-tr"><td colspan="11">未能找到相关数据</td></tr>
        <?php } ?>
        <?php ?>
        </tbody>
    </table>

    <div class="paginationnav">
        <div class="paginationnav-main">
            <div class="table-btn">
                <div class="btn-group">
                    <button type="button" class="btn btn-default group-checkable" data-set="#sorttable .checkboxes">全选</button>
                    <button type="button" class="btn btn-default group-offcheckable" data-set="#sorttable .checkboxes">取消</button>
                    <button type="button" class="btn btn-default group-anticheckable" data-set="#sorttable .checkboxes">反选</button>
                </div>
            </div>
            <?= $parcel->pagination->render(); ?>
            <div class="pagination-info">总计 <?= $parcel->count ?> 条</div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $("#sorttable .table").tablesorter({
        headers:{
            0:{sorter:false},
            6:{sorter:false}
        }
    });

    var list_sort_ord = [];
    $("#sortbody .sortr-user").each(function(i){
        list_sort_ord.push($(this).attr("rel"));
    })
    
	new Sortable(sortbody, {
    	group: "table",
        handle: ".sortr-handle",
        draggable: ".sortr-user",
        animation: 200,
        ghostClass: "sortable-ghost",
        store: {
            get: function (sortable) {
            },
            set: function (sortable) {
           	 var ids_order = [];
             $("#sortbody .sortr-user").each(function(i){
                 ids_order.push($(this).attr("cat_id"));
             })
             console.log('set.sort.ids:', ids_order);
             console.log('set.sort.list:', list_sort_ord);
            //    cols=cols.length>0?cols.substring(0,cols.length-1):"";
             $.post("/features/mediasort", { ids: ids_order, sorts: list_sort_ord} );
            }
        },
        onAdd: function (evt) {
            console.log('onAdd.sortbody:', evt.item);
        },
	    onUpdate: function (evt){ 
	        console.log('onUpdate.sortbody:', evt.item); 
	    	//selectItem = $(evt.item).find("input[name='id']").val();
	    },
        onRemove: function (evt) {
            console.log('onRemove.sortbody:', evt.item);
        },
        onStart: function (evt) {
            console.log('onStart.sortbody:', evt.item);
        },
        onEnd: function (evt) {
        	console.log('onEnd.sortbody:', evt.item);
		}
	});
</script>