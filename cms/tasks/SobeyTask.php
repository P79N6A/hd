<?php

/**
 * 索贝处理推送
 */
class SobeyTask extends Task {

    static $cat = [
        1=>[
            386=>[35],// 小鬼当家
            385=>[38],// 天姥人物
            384=>[39], // 天姥纪事,
            381=>[15], //沃州田野
            382=>[36], //沃州田野 整档
            383=>[37], //拆条
            380=>[16], //话题
            379=>[14],//我有一个梦
            378=>[13], //今日聚焦
            374=>[33],//新昌新闻
            376=>[45],//拆条
            375=>[34], //整档
            387=>[40], //夏青杯朗诵大赛
            389=>[47],
            390=>[48],
            395=>[102],

        ],
        12=>[
            119=>[4666],//  嵊州新闻
            117=>[4667],//  越剧大家唱
            116=>[4669], // 平安在嵊州
            115=>[4672], // 梦想大舞台
            114=>[4671], //越乡
            113=>[4670], //大地春色
            112=>[4668], // 新闻1+2
            111=>[4665], //帮忙三人行
            154=>[4673] // 嵊州新闻-拆条
        ],
        13=>[
            123=>[4835],//  诸暨新闻
            127=>[4836],//  暨阳时空
            128=>[4837],//  浣江纪事
            134=>[4838],//  快乐面对面
            135=>[4839],//  最美诸暨
            133=>[4840],//  汽车时尚
            132=>[4841],//  暨阳楼市
            131=>[4842],//  乡村道地
            129=>[4843],//  荷花朵朵
            130=>[4844],//  暨阳警方
            137=>[4845],//  财经报道
            138=>[4846],//  诸暨新闻-拆条
            172=>[4847],//  其他
            370=>[4848],//  城管之窗
            372=>[4849],//  政情面对面
            392=>[4850],//  新闻大视野
            393=>[4851],//  新闻大视野-拆条
            125=>[4861],//  诸广新闻
            126=>[4862],//  对农广播
        ],
        14=>[
            149=>[4960],//  上虞新闻
            150=>[4961],//  虞视说说看
            159=>[4962],//  逛街
            160=>[4963],//  金色田野
            161=>[4964],//  娥江纵横
            163=>[4965],//  教育在线
            164=>[4966],//  清洁家园
            165=>[4967],//  商都直通车
            166=>[4968],//  看楼市
            167=>[4969],//  就是爱美食
            168=>[4970],//  时尚前沿
            169=>[4971],//  上虞新闻拆条
            173=>[4972],//  城市你我他
            175=>[4973],//   其他相关类视频新闻
            177=>[4974],//  上虞警界
            178=>[4975],//  三区一城
            184=>[4976],//  天南地北上虞人
            199=>[4977],//  鉴宝上虞
            202=>[4978],//  精彩上虞
            362=>[4979],//  法治上虞
            368=>[4980],//  面对面
            179=>[4981],//  娥江先锋
            401=>[4984],//  社区零距离
            400=>[4983],//  时尚生活
            399=>[4982],//  上虞话讲文明
        ],
        15=>[
            152=>[5074],//  桐乡新闻-整档
            189=>[5075],//  桐乡新闻-拆条
            183=>[5068],//  印象桐乡
            181=>[5070],//  今日桐乡
            205=>[5076],//  魅力桐乡
            208=>[5078],//  桐乡民生-整档
            207=>[5079],//  桐乡民生-拆条
            212=>[5080],//  今日曝光
            396=>[5081],//  创业路上
            194=>[5083],//  我爱我家
            196=>[5084],//  旅游桐乡
            195=>[5085],//  青苹果
            197=>[5086],//  健康吧
        ],
        16=>[
            79=>[5137],//  非常快车道
            77=>[5138],//  小孩那么大
            81=>[5135],//  小龚统来讲
            75=>[5136],//  悦读衢州
            82=>[5128],//  衢州新闻
            71=>[5129],//  小齐说事
            74=>[5130],//  法治衢州
            83=>[5131],//  柯城新闻
            84=>[5132],//  衢江新闻
            73=>[5133],//  佳佳农话
            80=>[5134],//  财经报道
            97=>[5139],//  直播衢州
            98=>[5140],//  第一楼市
            72=>[5141],//  浙西先锋
            100=>[5142],//  衢州新闻(拆条)
            101=>[5143],//  直播衢州(拆条)
            102=>[5144],//  财经报道(拆条)
            109=>[5145],//  广信购物
            78=>[5146],//  教育视窗
            397=>[5147],//  城管零距离
        ],
        17=>[
            96=>[5412],//  今晚播报（拆条）
            95=>[5411],//  余姚新闻（拆条）
            45=>[5406],//  市委书记专区
            61=>[5407],//  余姚新闻
            58=>[5408],//  市长视频专区
            64=>[5409],//  记者关注
            62=>[5410],//  今晚播报
            367=>[5413],//  浙东抗战记忆
            44=>[5415],//  姚江田野
            56=>[5416],//  爱无与伦比
            49=>[5417],//  姚江流韵
            54=>[5418],//  清风车影
            51=>[5419],//  看楼市
            52=>[5420],//  余姚你好
            50=>[5421],//  姚江明月
            46=>[5422],//  姚江桥头
            47=>[5423],//  快乐碰碰车
            65=>[5424],//  放眼看天下
            57=>[5425],//  走遍宁波
            48=>[5426],//  探密
            53=>[5427],//  阿拉余姚人
            103=>[5428],//  欢乐大舞台
            104=>[5429],//  微型党课
            106=>[5430],//  公益广告
            203=>[5431],//  姚江光影
            70=>[5434],//  其他
            68=>[5435],//  广电精品
            67=>[5436],//  广播节目
        ]
    ];

    /**
     * 初始化分类
     */
    public function initCategoryAction() {
        if(!empty(self::$cat)) {
            foreach(self::$cat as $channel_id => $value) {
                SupplyToCategory::query()->andCondition('channel_id',$channel_id)->execute()->delete();
                if(!empty($value)) {
                    foreach($value as $supply_id => $aim_ids) {
                        if(!empty($aim_ids)) {
                            foreach($aim_ids as $v) {
                                $model = new SupplyToCategory();
                                $id = $model->save([
                                    'channel_id' => $channel_id,
                                    'supply_category_id' => $supply_id,
                                    'category_id' => $v
                                ]);
                                if($id) {
                                    $this->log($channel_id."-".$supply_id."-".$v." ------- [success]");
                                } else {
                                    $this->log($channel_id."-".$supply_id."-".$v." ------- [error]");
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    /**
     * @param $msg
     */
    protected function log($msg) {
        echo $msg, PHP_EOL;
    }

    /**
     * 处理队列
     */
    public function videoAction() {
        $data = Supplies::query()->andCondition('status', 0)->orderBy('created_at asc')->execute()->toArray();
        if(!empty($data)) {
            foreach($data as $v) {
                $this->doSyncOne($v);
            }
        }
    }

    /**
     * @param $v
     * @return bool
     */
    protected function doSyncOne($v) {
        $data = unserialize($v['origin_content']);
        $supply_id = $v['supply_category_id'];
        $data['channel_id'] = $v['channel_id'];
        $data['supply_id'] = $v['id'];
        $aim_id = SupplyToCategory::getAimId($data['channel_id'],$supply_id);
        $has = $this->checkSync($data);
        if($has) {
            $data['data_id'] = $has;
            if($this->updateSyncOne($data) && $this->publish($has, $aim_id, $data) && $this->updateSupplies($v['id'])){
                $this->log('update success');
                return true;
            }
        }
        try {
            DB::begin();
            $this->createCat($data);
            $new = $this->createData($data, 'video');
            if($new) {
                if($this->cpVideoFile($new['source_id'], $data) && $this->publish($new['data_id'], $aim_id, $new)) {
                    $sync = new SupplyRsync();
                    if($sync->save([
                            'channel_id' => $data['channel_id'],
                            'origin_type' => 1,
                            'origin_id' => $data['video_id'],
                            'data_id' => $new['data_id'],
                        ]) && $this->updateSupplies($v['id'])
                    ) {
                        $this->log('success');
                        DB::commit();
                    }
                } else {
                    $this->log('cpVideoFile error');
                    DB::rollback();
                    return false;
                }
            } else {
                $this->log('createData error');
                DB::rollback();
                return false;
            }
        } catch(\Exception $e) {
            dd($e->getMessage());
            DB::rollback();
            return false;
        }
    }

    /**
     * @param $id
     * @param int $status
     * @return bool
     */
    protected function updateSupplies($id, $status = 1) {
        return Supplies::findFirst($id)->update(['status' => $status]);
    }

    /**
     * @param $v
     * @return bool
     */
    protected function updateSyncOne($v) {
        $data = Data::findFirst($v['data_id']);
        if(!$data) {
            return false;
        }
        $update = [
            'title' => $v['video_title'],
            'intro' => isset($v['video_synopsis'])? $v['video_synopsis']: '',
            'status' => $this->parseStatus($v['video_status']),
            'created_at' => $v['video_airtime'],
            'updated_at' => time(),
        ];
        $update['thumb'] = $this->parseImage($v, 'video');
        return $data->update($update) && $this->updateVideo($data, $v);
    }


    /**
     * @param $data
     * @param $v
     * @return bool
     */
    protected function updateVideo($data, $v) {
        return Videos::findFirst($data->source_id)->update([
            'keywords' => isset($v['video_tags']) ? $v['video_tags'] :'',
            'created_at' => $v['video_airtime'],
        ]);
    }

    /**
     * 检查是否更新
     * @param $v
     * @return bool
     */
    protected function checkSync($v) {
        $sync = SupplyRsync::query()->andCondition('channel_id', $v['channel_id'])->andCondition('origin_type', 1)->andCondition('origin_id', $v['video_id'])->first();
        if($sync) {
            return $sync->data_id;
        }
        return false;
    }

    /**
     * 创建主表Data+关联表
     * @param $v
     * @param $type
     * @return bool
     */
    protected function createData($v, $type) {
        $model = new Data();
//        $user = $this->getUser($v);
        $data['type'] = $type;
        $func = 'create'.ucfirst($type);
        $data['channel_id'] = $v['channel_id'];
        $data['data_data'] = '[]';
        $data['created_at'] = $v['video_airtime'];
        $data['updated_at'] = $v['video_airtime'];
        $data['source_id'] = $this->$func($v);
        $data['title'] = $v['video_title'];
        $data['intro'] = isset($v['video_synopsis']) ? $v['video_synopsis'] :"";
        $data['thumb'] = $this->parseImage($v, $type);
        $data['author_id'] = 1;
        $data['author_name'] = 'system';
        $data['hits'] = 0;
        $data['status'] = $this->parseStatus($v['video_status']);
        $data['partition_by'] = date("Y", time());
        $data_id = $model->saveGetId($data);
        if($data_id) {
            $data['data_id'] = $data_id;
        } else {
            return false;
        }
        return $data;
    }

    /**
     * @param $v
     * @return \Phalcon\Mvc\ModelInterface
     */
    protected function getUser($v) {
        return Admin::query()
            ->andCondition('channel_id', $v['channel_id'])
            ->andCondition('is_admin', 1)
            ->andCondition('status', 1)
            ->first();
    }

    /**
     * @param $v
     * @param $type
     * @return string
     */
    protected function parseImage($v, $type) {
        if($type == 'video' && !empty($v['thumbnail_url'])) {
            $thumb = $v['thumbnail_url'];
            $ext = substr(strrchr($thumb, '.'), 1);
            $filename = pathinfo($thumb)['filename'].'.'.$ext;
            $path = httpcopy($thumb, APP_PATH.'../tasks/tmp/'.$filename, 120);
            if($path) {
                return Oss::uniqueUpload($ext, $path, $v['channel_id'].'/videos_thumb');
            }
        }
        return '';
    }

    /**
     * @param $v
     * @return int
     */
    protected function createVideo($v) {
        $model = new Videos();
        return $model->saveGetId([
            'channel_id' => $v['channel_id'],
            'collection_id' => 0,
            'duration' => $v['video_files'][0]['duration'],
            'created_at' => $v['video_airtime'],
            'updated_at' => time(),
            'keywords' => isset($v['video_tags']) ? $v['video_tags'] :'',
            'supply_id' => $v['supply_id'],
            'partition_by' => date('Y', time()),
        ]);
    }

    protected function cpVideoFile($video_id, $v) {
        if(!empty($v['video_files'])) {
            foreach($v['video_files'] as $file) {
                $model = new VideoFiles();
                $model->save([
                    'video_id' => $video_id,
                    'path' => $file['video_url'],
                    'rate' => $file['video_bitrate'],
                    'format' => $file['format'],
                    'width' => $file['width'],
                    'height' => $file['height'],
                    'partition_by' => date("Y", time())
                ]);
            }
        }
        return true;
    }

    /**
     * 多栏目发布
     * @param $new_id
     * @param $category_id
     * @param $data
     * @return bool
     */
    protected function publish($new_id, $category_id, $data) {
        if(!empty($category_id)) {
            CategoryData::query()->andCondition('data_id', $new_id)->execute()->delete();
            $catebind = CategoryBind::getbindByCategoryid($category_id[0]);
            foreach($catebind as $v) {
                $model = new CategoryData();
                $model->save([
                    'data_id' => $new_id,
                    'category_id' => $v,
                    'partition_by' => date('Y', $data['created'])
                ]);
                CategoryData::top($v, $new_id);
            }
            foreach($category_id as $id) {
                $model = new CategoryData();
                $model->save([
                    'data_id' => $new_id,
                    'category_id' => $id,
                    'partition_by' => date('Y', time())
                ]);
                CategoryData::top($id, $new_id);
            }
        }
        return true;
    }

    /**
     * @param $data
     * @return bool
     */
    protected function createCat($data) {
        return true;
    }

    protected function parseStatus($status) {
        return $status == 7? 0: 1;
    }

    /**
     * 初始化app数据导入
     */
    public function appAction() {
        // key pc
        $config = [
            6 => 78,
            1 => 79,
            34 => 81,
            13 => 82,
            14 => 83,
            15 => 84,
            16 => 85,
            38 => 86,
            39 => 87,
            35 => 89,
            40 => 90,
            5 => 93,
            8 => 94,
            9 => 95,
            10 => 96,
            11 => 97
        ];
        foreach($config as $k => $v) {
            $data = CategoryData::query()->andCondition('category_id',$k)->execute();
            if(!empty($data)){
                foreach($data as $c){
                    $model = new CategoryData();
                    $has = CategoryData::query()->andCondition('category_id',$v)->andCondition('data_id',$c->data_id)->first();
                    if(!$has) {
                        $model->save([
                            'data_id' => $c->data_id,
                            'category_id' => $v,
                            'sort' => $c->sort,
                            'weight' => $c->weight,
                            'partition_by' => $c->partition_by,
                        ]);
                        echo $c->data_id, PHP_EOL;
                    }
                }
            }
        }
    }

}